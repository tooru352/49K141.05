<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milano Coffee - B√°n h√†ng</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Jacques+Francois+Shadow&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="giaodichj.css"> 
</head>
<body>
    <div class="container">
  <!-- Header + Taskbar gi·ªëng c√°c trang kh√°c -->
  <div class="header">
    <div class="logo-section">
      <img class="logo" src="../Quan_ly_ban_hang/image/milano.jpg" alt="Logo">
      <div class="logo-text">MILANO COFFEE</div>
    </div>
    <!-- Thay to√†n b·ªô ph·∫ßn .user-area b·∫±ng ƒëo·∫°n n√†y -->
    <div class="user-area" onclick="window.location.href='../Thong_tin_ca_nhan/ttcanhan.html'">
      <!-- Trong .user-area -->
      <span class="user-id">
        <script>
          const user = JSON.parse(localStorage.getItem("currentUser"));
          document.write(user ? user.username : "NV0001");
        </script>
      </span>
      <img class="user-avatar" src="../Quan_ly_ban_hang/image/avatar.jpg" alt="Avatar">
    </div>
  </div>

  <!-- TASKBAR C√ì DROPDOWN ƒê·∫∏P Y CHANG H√åNH -->
<div class="taskbar">
  <a href="../Quan_ly_ban_hang/index.html">B√°n h√†ng</a>

    <a href="../nhaphang/nhaphang.html" >Nh·∫≠p h√†ng</a>
    <a href="../QuanLyTonKHo/index.html">T·ªìn kho</a>
    <div class="dropdown">
  <a href="#" class="dropdown-toggle">T·ªïng k·∫øt</a>
  <div class="dropdown-menu info-menu">
    <a href="../BaocaoNK/baocao.html">B√°o c√°o nh·∫≠p h√†ng</a>
    <a href="../baocaoDT/baocaoDT.html">B√°o c√°o doanh thu</a>
  </div>
</div>
   <!-- DROPDOWN "QU·∫¢N L√ù TH√îNG TIN" ‚Äì ƒê·∫∏P Y CHANG H√åNH B·∫†N G·ª¨I -->
<div class="dropdown">
  <a href="#" class="dropdown-toggle">Qu·∫£n l√Ω th√¥ng tin</a>
  <div class="dropdown-menu info-menu">
    <a href="../QuanLyNhanVien/index.html">Nh√¢n vi√™n</a>
    <a href="../QL_TT_NCC/QL_TT_NCC.html">Nh√† cung c·∫•p</a>
    <a href="../QL_TT_mon/Quan_ly_mon.html">M√≥n</a>
    <a href="../QL_TT_NL/nguyenlieu.html">Nguy√™n li·ªáu</a>
    <a href="../Quan_ly_tai_khoan/index.html">T√†i kho·∫£n</a>
    <a href="../giaodich/giaodich.html">L·ªãch s·ª≠ thanh to√°n</a>
  </div>
</div>
<div class="dropdown">
  <a href="#" class="dropdown-toggle">Nh√¢n vi√™n</a>
  <div class="dropdown-menu">
    <!-- Qu·∫£n l√Ω l∆∞∆°ng (c√≥ submenu) -->
    <div class="dropdown-submenu">
      <a href="#" class="dropdown-toggle-submenu">
        Qu·∫£n l√Ω l∆∞∆°ng 
        <span class="submenu-arrow">></span>
      </a>
      <div class="dropdown-menu submenu">
        <a href="../ql_luong/B·∫£ng c√¥ng/bc.html">B·∫£ng c√¥ng</a>
        <a href="../ql_luong/B·∫£ng l∆∞∆°ng/ql_luong.html">B·∫£ng l∆∞∆°ng</a>
        <a href="../ql_luong/T√≠nh l∆∞∆°ng/tluong.html">T√≠nh l∆∞∆°ng</a>
      </div>
    </div>

    <!-- Qu·∫£n l√Ω l·ªãch l√†m vi·ªác -->
    <a href="../ql_luong/L·ªãch l√†m/Llam.html">Qu·∫£n l√Ω l·ªãch l√†m vi·ªác</a>
  </div>
</div>
  </div>
  <!-- Icon quay l·∫°i -->
      <div class="back-to-dashboard" onclick="window.location.href='../Quan_ly_ban_hang/index.html'" title="Quay l·∫°i trang B√°n h√†ng">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="#c8a165" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <h1 style="text-align:center;color:#c8a165;margin-bottom: 30px;margin-top:-50px;">L·ªäCH S·ª¨ GIAO D·ªäCH</h1>
</div>          
        <!-- Main Content -->
        <div class="main">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="left-tools">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm">
                    </div>

                    <!-- Custom Date Picker - gi·ªëng h·ªát Nh·∫≠p h√†ng -->
                    <div class="custom-date-picker">
                        <input type="text" id="dateRangeInput" class="date-filter" readonly placeholder="T√πy ch·ªçn...">
                        <div class="datepicker-dropdown" id="datepickerDropdown">
                            <div class="calendars">
                                <div class="calendar" id="calendarLeft"></div>
                                <div class="calendar" id="calendarRight"></div>
                            </div>
                            <div class="datepicker-actions">
                                <button id="btnClearDate">X√≥a</button>
                                <button id="btnApplyDate">√Åp d·ª•ng</button>
                            </div>
                        </div>
                    </div>

                    <button class="btn-apply" id="btnApplyFilter">√Åp d·ª•ng</button>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>M√£ h√≥a ƒë∆°n</th>
                            <th>M√£ nh√¢n vi√™n</th>
                            <th>Th·ªùi gian</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="hoaDonBody"></tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <button>‚Äπ</button>
                <button class="active">1</button>
                <button>2</button>
                <button>3</button>
                <button>...</button>
                <button>‚Ä∫</button>
            </div>
        </div>
    </div>
<!-- Popup Chi Ti·∫øt H√≥a ƒê∆°n (XEM - Ch·ªâ ƒë·ªçc) -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-detail">
            <div class="popup-header">
                <button class="btn-back" onclick="closePopup()">‚Üê</button>
                <h2 id="popupTitle">HD089</h2>
                <button class="btn-close" onclick="closePopup()">√ó</button>
            </div>
            
            <div class="popup-info">
                <div class="info-row">
                    <span class="info-label" id="popupMaNV">NV001</span>
                    <span class="info-separator">|</span>
                    <span class="info-label" id="popupThoiGian">10:10 10/09/2025</span>
                    <span class="info-separator">|</span>
                    <span class="info-label" id="popupBan">BAN-1</span>
                </div>
            </div>

            <div class="popup-table">
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody id="popupTableBody">
                        <!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c load b·∫±ng JS -->
                    </tbody>
                </table>
            </div>

            <div class="popup-footer">
                <div class="footer-row">
                    <span>Khuy·∫øn m√£i</span>
                    <span id="popupKhuyenMai">0</span>
                </div>
                <div class="footer-row">
                    <span>Thu·∫ø</span>
                    <span id="popupThue">0</span>
                </div>
                <div class="footer-row total">
                    <span>T·ªîNG TI·ªÄN</span>
                    <span id="popupTongTien">61,000ƒë</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup S·ª≠a H√≥a ƒê∆°n -->
   <div class="popup-overlay" id="popupEditOverlay">
    <div class="popup-detail popup-edit">
        <div class="popup-header">
            <button class="btn-back" onclick="closeEditPopup()">‚Üê</button>
            <h2>S·ª≠a <span id="popupEditTitle">HD089</span></h2>
            <button class="btn-close" onclick="closeEditPopup()">√ó</button>
        </div>
        
        <!-- Th√¥ng tin chung - c√≥ th·ªÉ s·ª≠a -->
        <div class="popup-info edit-mode">
            <div class="info-row">
                <select id="editMaNV" class="edit-select"></select>
                <span class="info-separator">|</span>
                <input type="text" id="editThoiGian" class="edit-input" placeholder="HH:mm dd/MM/yyyy">
                <span class="info-separator">|</span>
                <select id="editBan" class="edit-select">
                    <option value="BAN-1">BAN-1</option>
                    <option value="BAN-2">BAN-2</option>
                    <option value="BAN-3">BAN-3</option>
                    <option value="BAN-4">BAN-4</option>
                    <option value="BAN-5">BAN-5</option>
                    <option value="BAN-6">BAN-6</option>
                    <option value="MANG-V">Mang v·ªÅ</option>
                </select>
            </div>
        </div>

        <!-- B·∫£ng s·∫£n ph·∫©m - c√≥ th·ªÉ s·ª≠a t·ª´ng d√≤ng -->
        <div class="popup-table">
            <table>
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="popupEditTableBody"></tbody>
            </table>
            <button class="btn-add-product" onclick="themSanPhamMoi()">+ Th√™m s·∫£n ph·∫©m</button>
        </div>

        <!-- Footer -->
        <div class="popup-footer">
            <div class="footer-row">
                <span>Khuy·∫øn m√£i</span>
                <input type="number" id="editKhuyenMai" class="edit-input-small" value="0" min="0">ƒë
            </div>
            <div class="footer-row">
                <span>Thu·∫ø</span>
                <input type="number" id="editThue" class="edit-input-small" value="0" min="0">ƒë
            </div>
            <div class="footer-row total">
                <span>T·ªîNG TI·ªÄN</span>
                <span id="popupEditTongTien">0ƒë</span>
            </div>
        </div>

        <!-- N√∫t h√†nh ƒë·ªông -->
        <div class="popup-actions">
            <button class="btn-save" onclick="luuChinhSua()">L∆∞u thay ƒë·ªïi</button>
        </div>
    </div>
</div>
    <div class="container">
        <!-- Header -->
        <div class="header">

<script>
    // ==================== L·ªåC D·ªÆ LI·ªÜU ====================
function applyFilters() {
    loadDanhSachHoaDon();
}
// ==================== BI·∫æN TO√ÄN C·ª§C ====================
let startDate = null;
let endDate = null;
let currentMaHD = null; // L∆∞u m√£ h√≥a ƒë∆°n hi·ªán t·∫°i trong popup
let currentHoaDon = null; // L∆∞u to√†n b·ªô d·ªØ li·ªáu h√≥a ƒë∆°n ƒëang ch·ªânh s·ª≠a
let editingSanPham = []; // Danh s√°ch s·∫£n ph·∫©m ƒëang ch·ªânh s·ª≠a

// ==================== LOAD TRANG ====================
document.addEventListener("DOMContentLoaded", function () {
    // Kh·ªüi t·∫°o d·ªØ li·ªáu m·∫´u n·∫øu ch∆∞a c√≥
    initSampleData();
    
    // Load danh s√°ch h√≥a ƒë∆°n
    loadDanhSachHoaDon();
    
    // Kh·ªüi t·∫°o date picker
    initDatePicker();

    // S·ª± ki·ªán t√¨m ki·∫øm v√† l·ªçc
    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("btnApplyFilter").addEventListener("click", applyFilters);
    document.getElementById("dateRangeInput").addEventListener("click", toggleDatePicker);
    
    // S·ª± ki·ªán ƒë√≥ng popup khi click overlay
    document.getElementById('popupOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closePopup();
        }
    });
    
    document.getElementById('popupEditOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditPopup();
        }
    });
});

// ==================== KH·ªûI T·∫†O D·ªÆ LI·ªÜU M·∫™U ====================
function initSampleData() {
    if (!localStorage.getItem('danhSachHoaDon')) {
        const sample = [
            { 
                maHoaDon: "HD091", 
                maNhanVien: "NV002", 
                thoiGian: "9:30 20/09/2025", 
                tongTien: 80000,
                ban: "BAN-2",
                khuyenMai: 0,
                thue: 0,
                sanPham: [
                    { stt: 1, ten: 'Tr√† s·ªØa tr√¢n ch√¢u', donGia: 35000, soLuong: 1, thanhTien: 35000 },
                    { stt: 2, ten: 'B√°nh flan', donGia: 15000, soLuong: 3, thanhTien: 45000 }
                ]
            },
            { 
                maHoaDon: "HD089", 
                maNhanVien: "NV001", 
                thoiGian: "10:10 10/09/2025", 
                tongTien: 61000,
                ban: "BAN-1",
                khuyenMai: 0,
                thue: 0,
                sanPham: [
                    { stt: 1, ten: 'C√† ph√™ s·ªØa Milano', donGia: 18000, soLuong: 1, thanhTien: 18000 },
                    { stt: 2, ten: 'B·∫°c x·ªâu mu·ªëi', donGia: 25000, soLuong: 1, thanhTien: 25000 },
                    { stt: 3, ten: 'B√°nh m√¨', donGia: 18000, soLuong: 1, thanhTien: 18000 }
                ]
            },
            { 
                maHoaDon: "HD088", 
                maNhanVien: "NV003", 
                thoiGian: "14:20 09/09/2025", 
                tongTien: 125000,
                ban: "BAN-5",
                khuyenMai: 0,
                thue: 0,
                sanPham: [
                    { stt: 1, ten: 'C√† ph√™ ƒëen', donGia: 15000, soLuong: 2, thanhTien: 30000 },
                    { stt: 2, ten: 'Sinh t·ªë b∆°', donGia: 35000, soLuong: 2, thanhTien: 70000 },
                    { stt: 3, ten: 'B√°nh ng·ªçt', donGia: 25000, soLuong: 1, thanhTien: 25000 }
                ]
            },
            { 
                maHoaDon: "HD087", 
                maNhanVien: "NV001", 
                thoiGian: "16:45 08/09/2025", 
                tongTien: 52000,
                ban: "BAN-3",
                khuyenMai: 0,
                thue: 0,
                sanPham: [
                    { stt: 1, ten: 'Cappuccino', donGia: 22000, soLuong: 2, thanhTien: 44000 },
                    { stt: 2, ten: 'Cookies', donGia: 8000, soLuong: 1, thanhTien: 8000 }
                ]
            }
        ];
        localStorage.setItem('danhSachHoaDon', JSON.stringify(sample));
    }
}

// ==================== L·ªåC D·ªÆ LI·ªÜU ====================
function applyFilters() {
    loadDanhSachHoaDon();
}

// ==================== LOAD DANH S√ÅCH H√ìA ƒê∆†N ====================
function loadDanhSachHoaDon() {
    const tbody = document.getElementById("hoaDonBody");
    let dsHoaDon = JSON.parse(localStorage.getItem('danhSachHoaDon') || '[]');

    const query = document.getElementById("searchInput").value.trim().toLowerCase();

    let filtered = dsHoaDon.filter(hd => {
        const matchSearch = hd.maHoaDon.toLowerCase().includes(query) || 
                           hd.maNhanVien.toLowerCase().includes(query);
        
        if (!startDate || !endDate) return matchSearch;
        
        const date = parseDateTime(hd.thoiGian);
        const start = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate(), 0, 0, 0);
        const end = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate(), 23, 59, 59);
        
        return matchSearch && date >= start && date <= end;
    });

    filtered.sort((a, b) => parseDateTime(b.thoiGian) - parseDateTime(a.thoiGian));

    tbody.innerHTML = '';

    if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">
            Ch∆∞a c√≥ h√≥a ƒë∆°n n√†o ph√π h·ª£p
        </td></tr>`;
        return;
    }

    filtered.forEach(hd => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${hd.maHoaDon}</td>
            <td>${hd.maNhanVien}</td>
            <td>${hd.thoiGian}</td>
            <td>${hd.tongTien.toLocaleString('vi-VN')}ƒë</td>
            <td class="actions">
                <button class="view-btn" onclick="xemChiTiet('${hd.maHoaDon}')">üëÅ</button>
                <button class="edit-btn" onclick="suaHoaDon('${hd.maHoaDon}')">‚úè</button>
                <button class="delete-btn" onclick="xoaHoaDon('${hd.maHoaDon}', this)">üóë</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// ==================== POPUP - XEM CHI TI·∫æT ====================
function xemChiTiet(maHD) {
    currentMaHD = maHD;
    const ds = JSON.parse(localStorage.getItem('danhSachHoaDon') || '[]');
    const hoaDon = ds.find(hd => hd.maHoaDon === maHD);
    
    if (!hoaDon) {
        alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n!');
        return;
    }

    // C·∫≠p nh·∫≠t th√¥ng tin header
    document.getElementById('popupTitle').textContent = hoaDon.maHoaDon;
    document.getElementById('popupMaNV').textContent = hoaDon.maNhanVien;
    document.getElementById('popupThoiGian').textContent = hoaDon.thoiGian;
    document.getElementById('popupBan').textContent = hoaDon.ban || 'BAN-1';

    // Load b·∫£ng s·∫£n ph·∫©m
    const sanPham = hoaDon.sanPham || [];
    const tbody = document.getElementById('popupTableBody');
    tbody.innerHTML = sanPham.map(sp => `
        <tr>
            <td>${sp.stt}</td>
            <td>${sp.ten}</td>
            <td>${sp.donGia.toLocaleString('vi-VN')}ƒë</td>
            <td>${sp.soLuong}</td>
            <td>${sp.thanhTien.toLocaleString('vi-VN')}ƒë</td>
        </tr>
    `).join('');

    // C·∫≠p nh·∫≠t footer
    document.getElementById('popupKhuyenMai').textContent = hoaDon.khuyenMai || 0;
    document.getElementById('popupThue').textContent = hoaDon.thue || 0;
    document.getElementById('popupTongTien').textContent = hoaDon.tongTien.toLocaleString('vi-VN') + 'ƒë';

    // Hi·ªÉn th·ªã popup
    document.getElementById('popupOverlay').classList.add('show');
}

function closePopup() {
    document.getElementById('popupOverlay').classList.remove('show');
    currentMaHD = null;
}

// ==================== POPUP CH·ªàNH S·ª¨A ====================
function suaHoaDon(maHD) {
    currentMaHD = maHD;
    const ds = JSON.parse(localStorage.getItem('danhSachHoaDon') || '[]');
    currentHoaDon = ds.find(hd => hd.maHoaDon === maHD);
    if (!currentHoaDon) return alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n!');

    // 1. Load danh s√°ch nh√¢n vi√™n v√†o <select>
    const selectNV = document.getElementById('editMaNV');
    selectNV.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';

    // N·∫øu b·∫°n c√≥ trang qu·∫£n l√Ω nh√¢n vi√™n th√¨ l·∫•y t·ª´ ƒë√≥, kh√¥ng th√¨ d√πng m·∫´u
    let dsNhanVien = JSON.parse(localStorage.getItem('danhSachNhanVien') || '[]');
    if (dsNhanVien.length === 0) {
        dsNhanVien = [
            { maNV: "NV001", hoTen: "Nguy·ªÖn VƒÉn A" },
            { maNV: "NV002", hoTen: "Tr·∫ßn Th·ªã B" },
            { maNV: "NV003", hoTen: "L√™ VƒÉn C" }
        ];
    }
    dsNhanVien.forEach(nv => {
        const opt = document.createElement('option');
        opt.value = nv.maNV;
        opt.textContent = `${nv.maNV} - ${nv.hoTen}`;
        selectNV.appendChild(opt);
    });

    // 2. ƒêi·ªÅn d·ªØ li·ªáu v√†o c√°c √¥ s·ª≠a (ƒë√¢y l√† ch·ªó b·∫°n sai tr∆∞·ªõc ƒë√≥!)
    document.getElementById('popupEditTitle').textContent = currentHoaDon.maHoaDon;
    document.getElementById('editMaNV').value = currentHoaDon.maNhanVien;           // D√πng .value
    document.getElementById('editThoiGian').value = currentHoaDon.thoiGian;         // D√πng .value
    document.getElementById('editBan').value = currentHoaDon.ban || 'BAN-1';      // D√πng .value
    document.getElementById('editKhuyenMai').value = currentHoaDon.khuyenMai || 0;  // D√πng .value
    document.getElementById('editThue').value = currentHoaDon.thue || 0;            // D√πng .value

    // 3. Clone v√† render b·∫£ng s·∫£n ph·∫©m
    editingSanPham = JSON.parse(JSON.stringify(currentHoaDon.sanPham || []));
    renderEditTable();

    // 4. Hi·ªÉn th·ªã popup
    document.getElementById('popupEditOverlay').classList.add('show');
}

// Render b·∫£ng s·∫£n ph·∫©m trong popup s·ª≠a
function renderEditTable() {
    const tbody = document.getElementById('popupEditTableBody');
    tbody.innerHTML = editingSanPham.map((sp, i) => `
        <tr>
            <td>${i + 1}</td>
            <td><input type="text" class="edit-sp-input" value="${sp.ten}" onchange="capNhatSP(${i},'ten',this.value)"></td>
            <td><input type="number" class="edit-sp-input" value="${sp.donGia}" onchange="capNhatSP(${i},'donGia',this.value)"></td>
            <td><input type="number" class="edit-sp-input" value="${sp.soLuong}" min="1" onchange="capNhatSP(${i},'soLuong',this.value)"></td>
            <td>${(sp.donGia * sp.soLuong).toLocaleString('vi-VN')}ƒë</td>
            <td><button type="button" onclick="xoaSanPham(${i})">X√≥a</button></td>
        </tr>
    `).join('');

    tinhTongTienEdit(); // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
}

function capNhatSP(i, field, val) {
    if (field === 'donGia' || field === 'soLuong') {
        editingSanPham[i][field] = parseFloat(val) || 0;
    } else {
        editingSanPham[i][field] = val;
    }
    editingSanPham[i].thanhTien = editingSanPham[i].donGia * editingSanPham[i].soLuong;
    renderEditTable();
}

function xoaSanPham(i) {
    if (confirm('X√≥a s·∫£n ph·∫©m n√†y?')) {
        editingSanPham.splice(i, 1);
        renderEditTable();
    }
}

function themSanPhamMoi() {
    editingSanPham.push({ ten: 'S·∫£n ph·∫©m m·ªõi', donGia: 0, soLuong: 1, thanhTien: 0 });
    renderEditTable();
}

function tinhTongTienEdit() {
    const tongSP = editingSanPham.reduce((t, sp) => t + sp.thanhTien, 0);
    const km = parseFloat(document.getElementById('editKhuyenMai').value) || 0;
    const thue = parseFloat(document.getElementById('editThue').value) || 0;
    const tong = tongSP - km + thue;
    document.getElementById('popupEditTongTien').textContent = tong.toLocaleString('vi-VN') + 'ƒë';
}

function closeEditPopup() {
    document.getElementById('popupEditOverlay').classList.remove('show');
    currentMaHD = currentHoaDon = editingSanPham = null;
}

// ==================== L∆ØU S·ª¨A ====================
function luuChinhSua() {
    if (!confirm('L∆∞u c√°c thay ƒë·ªïi?')) return;

    // C·∫≠p nh·∫≠t t·ª´ c√°c input
    currentHoaDon.maNhanVien = document.getElementById('editMaNV').value;
    currentHoaDon.thoiGian = document.getElementById('editThoiGian').value.trim();
    currentHoaDon.ban = document.getElementById('editBan').value;
    currentHoaDon.khuyenMai = parseFloat(document.getElementById('editKhuyenMai').value) || 0;
    currentHoaDon.thue = parseFloat(document.getElementById('editThue').value) || 0;
    currentHoaDon.sanPham = editingSanPham;

    // T√≠nh l·∫°i t·ªïng ti·ªÅn
    currentHoaDon.tongTien = editingSanPham.reduce((t, sp) => t + sp.thanhTien, 0) 
                              - currentHoaDon.khuyenMai + currentHoaDon.thue;

    // L∆∞u v√†o localStorage
    let ds = JSON.parse(localStorage.getItem('danhSachHoaDon'));
    const idx = ds.findIndex(x => x.maHoaDon === currentMaHD);
    ds[idx] = currentHoaDon;
    localStorage.setItem('danhSachHoaDon', JSON.stringify(ds));

    alert('ƒê√£ l∆∞u th√†nh c√¥ng!');
    closeEditPopup();
    loadDanhSachHoaDon();
}

// ==================== S·ª¨A / X√ìA H√ìA ƒê∆†N ====================
function xoaHoaDon(maHD, btn) {
    if (confirm(`X√≥a h√≥a ƒë∆°n ${maHD}?`)) {
        let ds = JSON.parse(localStorage.getItem('danhSachHoaDon') || '[]');
        ds = ds.filter(hd => hd.maHoaDon !== maHD);
        localStorage.setItem('danhSachHoaDon', JSON.stringify(ds));
        btn.closest('tr').remove();
    }
}

// ==================== DATE PICKER ====================
function initDatePicker() {
    const today = new Date();
    renderCalendar(today.getFullYear(), today.getMonth(), 'calendarLeft');
    renderCalendar(today.getFullYear(), today.getMonth() + 1, 'calendarRight');

    document.getElementById("btnApplyDate").addEventListener("click", () => {
        updateDateRangeInput();
        document.getElementById("datepickerDropdown").classList.remove("show");
        applyFilters();
    });

    document.getElementById("btnClearDate").addEventListener("click", () => {
        startDate = endDate = null;
        updateDateRangeInput();
        document.getElementById("datepickerDropdown").classList.remove("show");
        applyFilters();
    });
}

function toggleDatePicker() {
    document.getElementById("datepickerDropdown").classList.toggle("show");
}

function updateDateRangeInput() {
    if (startDate && endDate) {
        document.getElementById("dateRangeInput").value = `${formatDate(startDate)} - ${formatDate(endDate)}`;
    } else {
        document.getElementById("dateRangeInput").value = "";
    }
}

function renderCalendar(year, month, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    const monthNames = ["Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                       "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"];
    
    // Header th√°ng
    const header = document.createElement('div');
    header.className = 'month-header';
    header.innerHTML = `
        <button class="prev-month" onclick="changeMonth(-1, '${containerId}')">&lt;</button>
        <span>${monthNames[month]} ${year}</span>
        <button class="next-month" onclick="changeMonth(1, '${containerId}')">&gt;</button>
    `;
    container.appendChild(header);
    
    // Th·ª©
    const weekdays = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
    const weekRow = document.createElement('div');
    weekRow.className = 'weekdays';
    weekRow.innerHTML = weekdays.map(d => `<div>${d}</div>`).join('');
    container.appendChild(weekRow);
    
    // Ng√†y
    const daysContainer = document.createElement('div');
    daysContainer.className = 'days-grid';
    
    const firstDay = new Date(year, month, 1).getDay();
    const offset = firstDay === 0 ? 6 : firstDay - 1;
    
    // √î tr·ªëng
    for (let i = 0; i < offset; i++) {
        daysContainer.innerHTML += '<div class="day empty"></div>';
    }
    
    // Ng√†y trong th√°ng
    const lastDate = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= lastDate; d++) {
        const date = new Date(year, month, d);
        const dayDiv = document.createElement('div');
        dayDiv.className = 'day';
        dayDiv.textContent = d;
        dayDiv.dataset.date = date.toISOString().split('T')[0];
        dayDiv.onclick = () => selectDate(date);
        
        // Highlight n·∫øu ƒë√£ ch·ªçn
        if (startDate && date.toDateString() === startDate.toDateString()) {
            dayDiv.classList.add('selected');
        }
        if (endDate && date.toDateString() === endDate.toDateString()) {
            dayDiv.classList.add('selected');
        }
        if (startDate && endDate && date > startDate && date < endDate) {
            dayDiv.classList.add('in-range');
        }
        
        daysContainer.appendChild(dayDiv);
    }
    
    container.appendChild(daysContainer);
}

function selectDate(date) {
    if (!startDate || endDate) {
        startDate = date;
        endDate = null;
    } else {
        if (date < startDate) {
            endDate = startDate;
            startDate = date;
        } else {
            endDate = date;
        }
    }
    
    // Re-render c·∫£ 2 calendar
    const today = new Date();
    renderCalendar(today.getFullYear(), today.getMonth(), 'calendarLeft');
    renderCalendar(today.getFullYear(), today.getMonth() + 1, 'calendarRight');
}

function changeMonth(delta, containerId) {
    // Logic chuy·ªÉn th√°ng (c√≥ th·ªÉ c·∫£i thi·ªán th√™m)
}

// ==================== HELPER FUNCTIONS ====================
function parseDateTime(str) {
    const parts = str.match(/(\d{1,2}):(\d{2}) (\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (!parts) return new Date();
    return new Date(parts[5], parts[4]-1, parts[3], parts[1], parts[2]);
}

function formatDate(date) {
    return `${date.getDate().toString().padStart(2,'0')}/${(date.getMonth()+1).toString().padStart(2,'0')}/${date.getFullYear()}`;
}
</script>
</body>
</html>