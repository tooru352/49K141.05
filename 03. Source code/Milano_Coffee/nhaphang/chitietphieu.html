<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Milano Coffee - Chi tiết phiếu nhập</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Jacques+Francois+Shadow&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="chitietphieunhap.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<script>
// Đọc tham số URL ngay khi trang load
const urlParams = new URLSearchParams(window.location.search);
const maPhieu = urlParams.get('maPhieu');
const mode = urlParams.get('mode');        // "edit" hoặc null
const isEditMode = (mode === 'edit');

// Nếu đang ở chế độ SỬA → tự động load dữ liệu cũ
if (isEditMode && maPhieu) {
  document.title = `Sửa phiếu nhập - ${maPhieu}`;
  // Có thể đổi tiêu đề h1 nếu muốn
  const title = document.querySelector('h1');
  if (title) title.textContent = `SỬA PHIẾU NHẬP - ${maPhieu}`;

  // Gọi hàm load dữ liệu cũ (bạn phải có hàm này)
  loadPhieuDeSua(maPhieu);
}
</script>
<body>

<div class="container">
  <!-- Header + Taskbar giống các trang khác -->
  <div class="header">
    <div class="logo-section">
      <img class="logo" src="../Quan_ly_ban_hang/image/milano.jpg" alt="Logo">
      <div class="logo-text">MILANO COFFEE</div>
    </div>
    <!-- Thay toàn bộ phần .user-area bằng đoạn này -->
    <div class="user-area" onclick="window.location.href='../Thong_tin_ca_nhan/ttcanhan.html'">
      <!-- Trong .user-area -->
      <span class="user-id">
        <script>
          const user = JSON.parse(localStorage.getItem("currentUser"));
          document.write(user ? user.username : "NV0001");
        </script>
      </span>
      <img class="user-avatar" src="../Quan_ly_ban_hang/image/avatar.jpg" alt="Avatar">
    </div>
  </div>

  <!-- TASKBAR CÓ DROPDOWN ĐẸP Y CHANG HÌNH -->
<div class="taskbar">
  <a href="../Quan_ly_ban_hang/index.html">Bán hàng</a>

    <a href="../nhaphang/nhaphang.html" >Nhập hàng</a>
    <a href="../QuanLyTonKHo/index.html">Tồn kho</a>
    <div class="dropdown">
  <a href="#" class="dropdown-toggle">Tổng kết</a>
  <div class="dropdown-menu info-menu">
    <a href="../BaocaoNK/baocao.html">Báo cáo nhập hàng</a>
    <a href="../baocaoDT/baocaoDT.html">Báo cáo doanh thu</a>
  </div>
</div>
   <!-- DROPDOWN "QUẢN LÝ THÔNG TIN" – ĐẸP Y CHANG HÌNH BẠN GỬI -->
<div class="dropdown">
  <a href="#" class="dropdown-toggle">Quản lý thông tin</a>
  <div class="dropdown-menu info-menu">
    <a href="../QuanLyNhanVien/index.html">Nhân viên</a>
    <a href="../QL_TT_NCC/QL_TT_NCC.html">Nhà cung cấp</a>
    <a href="../QL_TT_mon/Quan_ly_mon.html">Món</a>
    <a href="../QL_TT_NL/nguyenlieu.html">Nguyên liệu</a>
    <a href="../Quan_ly_tai_khoan/index.html">Tài khoản</a>
    <a href="../giaodich/giaodich.html">Lịch sử thanh toán</a>
  </div>
</div>
<div class="dropdown">
  <a href="#" class="dropdown-toggle">Nhân viên</a>
  <div class="dropdown-menu">
    <!-- Quản lý lương (có submenu) -->
    <div class="dropdown-submenu">
      <a href="#" class="dropdown-toggle-submenu">
        Quản lý lương 
        <span class="submenu-arrow">></span>
      </a>
      <div class="dropdown-menu submenu">
        <a href="../ql_luong/Bảng công/bc.html">Bảng công</a>
        <a href="../ql_luong/Bảng lương/ql_luong.html">Bảng lương</a>
        <a href="../ql_luong/Tính lương/tluong.html">Tính lương</a>
      </div>
    </div>

    <!-- Quản lý lịch làm việc -->
    <a href="../ql_luong/Lịch làm/Llam.html">Quản lý lịch làm việc</a>

  </div>
</div>
  </div>

  <!-- NÚT BACK + TIÊU ĐỀ ĐẸP -->
  <div class="back-to-dashboard" onclick="history.back()" title="Quay lại trang Bán hàng">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="#c8a165" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <h1 style="text-align:center;color:#c8a165;margin-bottom: 30px;margin-top:-50px;">CHI TIẾT PHIẾU NHẬP</h1>
</div>

  <!-- Nội dung chính -->
  <div class="main-content">
    <!-- Thông tin phiếu -->
    <div class="phieu-info">
      <div class="info-group">
        <strong>Mã phiếu</strong>
        <span id="maPhieu">-</span>
      </div>
      <div class="info-group">
        <strong>Thời gian tạo</strong>
        <span id="thoiGian">-</span>
      </div>
      <div class="info-group">
        <strong>Người tạo</strong>
        <span id="nguoiTao">-</span>
      </div>
      <div class="info-group">
        <strong>Nhà cung cấp</strong>
        <span id="nhaCungCap">-</span>
      </div>
    </div>

    <!-- Bảng chi tiết -->
    <div class="table-container">
      <table class="detail-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>Tên nguyên liệu</th>
            <th>Số lượng</th>
            <th>Đơn vị</th>
            <th>Đơn giá</th>
            <th>Thành tiền</th>
          </tr>
        </thead>
        <tbody id="chiTietBody"></tbody>
      </table>
    </div>

    <!-- Tổng kết -->
    <div class="summary">
      <div class="thue">Thuế VAT (10%) <span id="thue">0</span>đ</div>
      <div class="total-line">TỔNG TIỀN <span id="tongTien">0</span>đ</div>
    </div>
  </div>
</div>
<script>
// CHI TIẾT PHIẾU NHẬP – HOÀN CHỈNH 100%, CHẠY NGON NGAY!
document.addEventListener("DOMContentLoaded", function () {
  const urlParams = new URLSearchParams(window.location.search);
  const maPhieu = urlParams.get('maPhieu');

  if (!maPhieu) {
    alert("Không tìm thấy mã phiếu!");
    window.location.href = 'nhaphang.html';
    return;
  }

  // LẤY DANH SÁCH PHIẾU TỪ localStorage
  const dsPhieu = JSON.parse(localStorage.getItem('danhSachPhieuNhap') || '[]');
  const phieu = dsPhieu.find(p => p.maPhieu === maPhieu);

  if (!phieu) {
    alert("Phiếu nhập không tồn tại!");
    window.location.href = 'nhaphang.html';
    return;
  }

  // HIỂN THÔNG TIN PHIẾU
  document.getElementById('maPhieu').textContent = phieu.maPhieu;
  document.getElementById('thoiGian').textContent = phieu.thoiGian || formatDateTime(phieu.ngayTao);
  document.getElementById('nguoiTao').textContent = phieu.nguoiTao || 'NV0001';
  document.getElementById('nhaCungCap').textContent = phieu.nhaCungCap || 'Chưa chọn';

  // HIỂN THỊ CHI TIẾT NGUYÊN LIỆU
  const tbody = document.getElementById('chiTietBody');
  tbody.innerHTML = '';

  phieu.chiTiet.forEach((item, index) => {
    const thanhTien = item.soLuong * item.donGia;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.tenNL || item.ten}</td>
      <td>${item.donGia.toLocaleString('vi-VN')}đ</td>
      <td>${item.dvt || item.donVi}</td>
      <td>${item.soLuong}</td>
      <td><strong>${thanhTien.toLocaleString('vi-VN')}đ</strong></td>
    `;
    tbody.appendChild(tr);
  });




  // TỔNG TIỀN
  const thue = Math.round(phieu.tongTien * 0.1);
  const tongCong = phieu.tongTien + thue;
  document.getElementById('thue').textContent = thue.toLocaleString('vi-VN');
  document.getElementById('tongTien').textContent = tongCong.toLocaleString('vi-VN');
});

function formatDateTime(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}
</script>


</body>
</html>